# 复读插件

CoolQBot 的复读功能插件，提供智能复读、排行榜统计和历史记录查询等功能。

## 功能概览

### 智能复读

- 按照配置的概率自动复读群内消息
- 支持多平台适配（OneBot V11/V12）
- 可配置复读间隔和概率
- 智能过滤不适合复读的消息类型

### 复读排行榜

- 统计群成员的复读次数和消息数量
- 支持设置最低消息数量门槛
- 可自定义显示人数
- 基于欧皇/非酋概率计算排行

### 历史记录查询

- 查看指定日期的复读数据
- 支持按年、月、日查询
- 提供详细的历史统计信息

## 插件结构

```text
repeat/
├── __init__.py          # 插件主入口
├── config.py            # 配置文件
├── models.py            # 数据模型
├── recorder.py          # 数据记录器
├── plugins/             # 子功能模块
│   ├── repeat_basic/    # 基础复读功能
│   ├── repeat_rank/     # 排行榜功能
│   └── repeat_history/  # 历史记录功能
└── migrations/          # 数据库迁移文件
```

## 配置说明

在 `.env` 文件中添加以下配置：

```env
# 复读概率 (1-100)
REPEAT_RATE=10

# 复读间隔 (分钟)
REPEAT_INTERVAL=1

# 排除复读的用户列表 (支持用户名或用户ID)
REPEAT_EXCLUDED_USERS=["bot", "admin", 123456]

# 旧数据迁移群号 (仅在升级时需要)
REPEAT_MIGRATION_GROUP_ID=123456789
```

### 配置参数说明

- `REPEAT_RATE`: 复读概率，取值范围 1-100，默认为 10（即 10% 概率）
- `REPEAT_INTERVAL`: 复读间隔，单位分钟，默认为 1 分钟
- `REPEAT_EXCLUDED_USERS`: 排除复读的用户列表，可以是用户名或用户 ID
- `REPEAT_MIGRATION_GROUP_ID`: 用于数据迁移的群号，仅在从旧版本升级时需要

## 使用方法

### 基础复读功能

#### 查看复读状态

```bash
/复读
/repeat
```

#### 启用复读功能

```bash
/复读 on
/repeat on
```

#### 关闭复读功能

```bash
/复读 off
/repeat off
```

### 复读排行榜

#### 查看当前排行榜（默认显示前 3 名）

```bash
/复读排行榜
/rank
```

#### 显示指定人数的排行榜

```bash
/rank 5          # 显示前 5 名
```

#### 设置最低消息数量门槛

```bash
/rank n30        # 要求至少发送 30 条消息才能上榜
```

#### 组合参数

```bash
/rank 5n30       # 显示前 5 名，且要求至少发送 30 条消息
```

### 历史记录查询

#### 查看指定年份的数据

```bash
/复读历史 2024
/history 2024
```

#### 查看指定月份的数据

```bash
/history 2024-7   # 查看 2024年7月 的数据
```

#### 查看指定日期的数据

```bash
/history 2024-7-29  # 查看 2024年7月29日 的数据
```

## 复读规则

插件会智能判断是否需要复读消息，以下情况**不会**进行复读：

1. **用户排除**: 配置中排除的用户发送的消息
2. **@机器人**: 对机器人说话的消息（由闲聊插件处理）
3. **指令消息**: 以 `/` 开头的指令消息
4. **特殊消息类型**: 签到、分享、小程序、转发、红包等
5. **包含链接**: 含有 `http://` 或 `https://` 的消息
6. **应用消息**: 来自应用（user_id=1000000）的消息
7. **时间限制**: 复读后的指定时间间隔内
8. **群组未启用**: 未开启复读功能的群组

## 数据存储

### 数据库表结构

#### MessageRecord 表

- 记录每日用户的消息数量和复读次数
- 支持多平台（platform, group_id, guild_id, channel_id）
- 按日期统计数据

#### Enabled 表

- 记录哪些群组启用了复读功能
- 支持多平台标识

### 缓存数据

- 使用 `nonebot-plugin-datastore` 存储临时数据
- 记录最近的消息发送时间和复读时间
- 支持数据版本升级和迁移

## 开发说明

### 依赖插件

- `nonebot_plugin_datastore`: 数据存储
- `nonebot_plugin_orm`: ORM 数据库操作
- `nonebot_plugin_user`: 用户管理
- `nonebot_plugin_alconna`: 命令解析

### 核心组件

#### Recorder 类

负责记录和管理复读相关数据：

- 消息数量统计
- 复读次数记录
- 时间间隔控制
- 群组状态管理

#### repeat_rule 函数

复读判断的核心逻辑，决定是否对某条消息进行复读。
